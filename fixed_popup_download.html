<!DOCTYPE html>
<html>
<head>
    <title>Fixed Popup Download</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 12px 24px; font-size: 16px; cursor: pointer; margin: 10px; }
        .status { margin: 20px 0; padding: 15px; border-radius: 5px; }
        .loading { background: #fff3cd; border: 1px solid #ffeaa7; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    </style>
</head>
<body>
    <h1>Fixed Popup Download Test</h1>
    <p>This version ensures proper session cookie sharing between parent and popup windows.</p>
    
    <button onclick="fixedPopupDownload()">Test Fixed Popup Download</button>
    <div id="status" class="status loading">Ready to test...</div>

    <script>
    function fixedPopupDownload() {
        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = 'Creating popup with shared session...';
        statusDiv.className = 'status loading';
        
        // Create popup with opener relationship to share session
        const popup = window.open('', '_blank', 'width=500,height=400');
        if (!popup) {
            statusDiv.innerHTML = '‚ùå Popup blocked! Please allow popups for this site.';
            statusDiv.className = 'status error';
            return;
        }
        
        // Write popup content that inherits session
        popup.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Shared Session Download</title>
                <style>
                    body { font-family: Arial, sans-serif; text-align: center; padding: 30px; }
                    .status { margin: 20px 0; padding: 15px; border-radius: 5px; }
                    .loading { background: #fff3cd; border: 1px solid #ffeaa7; }
                    .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
                    .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
                    .spinner { 
                        border: 4px solid #f3f3f3; 
                        border-top: 4px solid #3498db; 
                        border-radius: 50%; 
                        width: 40px; 
                        height: 40px; 
                        animation: spin 1s linear infinite; 
                        margin: 20px auto; 
                    }
                    @keyframes spin { 
                        0% { transform: rotate(0deg); } 
                        100% { transform: rotate(360deg); } 
                    }
                </style>
            </head>
            <body>
                <h2>üì• Processing Download</h2>
                <div class="spinner"></div>
                <div id="status" class="status loading">Initializing with shared session...</div>
                
                <script>
                    // Access parent window's cookies to ensure session sharing
                    console.log('Popup loaded - checking session inheritance');
                    console.log('Document cookie:', document.cookie);
                    console.log('Opener available:', !!window.opener);
                    
                    // Update status
                    document.getElementById('status').innerHTML = 'Session inherited - starting download...';
                    
                    // Fetch with credentials included
                    fetch('/export_patients', {
                        method: 'GET',
                        credentials: 'same-origin', // This should inherit parent session
                        headers: {
                            'Accept': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                        }
                    })
                    .then(response => {
                        console.log('Response status:', response.status);
                        console.log('Content-Type:', response.headers.get('Content-Type'));
                        
                        document.getElementById('status').innerHTML = 'Response received - processing file...';
                        
                        if (!response.ok) {
                            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                        }
                        
                        // Check if we got HTML instead of Excel (auth failed)
                        const contentType = response.headers.get('Content-Type');
                        if (contentType && contentType.includes('text/html')) {
                            throw new Error('Authentication failed - received HTML redirect');
                        }
                        
                        return response.blob();
                    })
                    .then(blob => {
                        console.log('Blob size:', blob.size);
                        console.log('Blob type:', blob.type);
                        
                        document.getElementById('status').innerHTML = 'File processed - triggering download...';
                        
                        // Create download link
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'patients_export_' + new Date().toISOString().slice(0,19).replace(/:/g,'') + '.xlsx';
                        document.body.appendChild(a);
                        a.click();
                        
                        document.getElementById('status').innerHTML = '<div class="status success">‚úÖ Download started! Closing in 2 seconds...</div>';
                        URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        // Close popup after short delay
                        setTimeout(() => window.close(), 2000);
                    })
                    .catch(error => {
                        console.error('Download error:', error);
                        document.getElementById('status').innerHTML = '<div class="status error">‚ùå Download failed: ' + error.message + '</div>';
                    });
                </script>
            </body>
            </html>
        `);
        
        statusDiv.innerHTML = '‚úÖ Popup created with shared session! Check the popup window.';
        statusDiv.className = 'status success';
    }
    </script>
</body>
</html>