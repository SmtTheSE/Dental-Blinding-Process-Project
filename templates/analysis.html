{% extends "base.html" %}

{% block title %}Analysis Results - Dental Age Estimation System{% endblock %}

{% block content %}
<div class="container">
    <h2>Analysis Results</h2>
    <p>Comparison of actual ages with estimated ages using both methods.</p>
    
    <!-- Search Form -->
    <form method="GET" action="/analysis">
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
            <input 
                type="text" 
                name="search" 
                placeholder="Search by Patient ID, Name, or Codes..." 
                value="{{ search_query or '' }}"
                style="flex: 1; min-width: 200px; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: var(--border-radius); font-size: 1rem; box-sizing: border-box;"
            >
            <button type="submit" class="btn">Search</button>
            {% if search_query %}
            <a href="/analysis" class="btn btn-secondary">Clear</a>
            {% endif %}
        </div>
    </form>
    
    {% if accuracy_chart or comparison_chart %}
    <div style="background: white; padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--box-shadow); margin-bottom: 2rem;">
        <h3>Visual Analysis</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem;">
            {% if accuracy_chart %}
            <div>
                <h4>Accuracy Comparison</h4>
                <img src="data:image/png;base64,{{ accuracy_chart }}" alt="Accuracy Comparison Chart" style="max-width: 100%;">
            </div>
            {% endif %}
            
            {% if comparison_chart %}
            <div>
                <h4>Method Comparison</h4>
                <img src="data:image/png;base64,{{ comparison_chart }}" alt="Method Comparison Chart" style="max-width: 100%;">
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <div id="search-results-container">
        {% if search_query %}
        <div class="search-results-info">
            Search results for: <strong>"{{ search_query }}"</strong> ({{ patients.total }} patient{{ patients.total != 1 and 's' or '' }})
        </div>
        {% endif %}

        {% if results %}
        <table>
            <tr>
                <th>Patient ID</th>
                <th>Name</th>
                <th>Actual Age</th>
                <th>Sex</th>
                <th>OPG Image</th>
                <th>Code A (AlQahtani)</th>
                <th>Code B (Demirjian)</th>
                <th>AlQahtani Estimation</th>
                <th>Demirjian Estimation</th>
            </tr>
            {% for result in results %}
            <tr>
                <td>{{ result.patient_id }}</td>
                <td>{{ result.name or 'N/A' }}</td>
                <td>{{ result.actual_age }}</td>
                <td>{{ result.sex }}</td>
                <td>
                    {% if result.opg_link %}
                    <img src="{{ result.opg_link }}" alt="OPG Image" style="max-width: 100px; max-height: 100px; border-radius: 4px;">
                    {% else %}
                    No image
                    {% endif %}
                </td>
                <td>{{ result.code_a or 'Not assigned' }}</td>
                <td>{{ result.code_b or 'Not assigned' }}</td>
                <td>{{ result.alqahtani_estimated_age or 'Not estimated' }}</td>
                <td>{{ result.demirjian_estimated_age or 'Not estimated' }}</td>
            </tr>
            {% endfor %}
        </table>
        
        <!-- Pagination Controls -->
        {% if patients.pages > 1 %}
        <div class="pagination">
            <!-- Previous button -->
            {% if patients.has_prev %}
                <a href="{{ url_for('main.analysis', page=patients.prev_num, search=search_query) }}" class="btn btn-secondary">&laquo; Previous</a>
            {% else %}
                <span class="btn btn-secondary disabled">&laquo; Previous</span>
            {% endif %}
            
            <!-- Page numbers -->
            {% for page_num in patients.iter_pages() %}
                {% if page_num %}
                    {% if page_num != patients.page %}
                        <a href="{{ url_for('main.analysis', page=page_num, search=search_query) }}" class="btn btn-secondary">{{ page_num }}</a>
                    {% else %}
                        <span class="btn active">{{ page_num }}</span>
                    {% endif %}
                {% else %}
                    <span class="ellipsis">â€¦</span>
                {% endif %}
            {% endfor %}
            
            <!-- Next button -->
            {% if patients.has_next %}
                <a href="{{ url_for('main.analysis', page=patients.next_num, search=search_query) }}" class="btn btn-secondary">Next &raquo;</a>
            {% else %}
                <span class="btn btn-secondary disabled">Next &raquo;</span>
            {% endif %}
        </div>
        {% endif %}
        
        {% else %}
        <div style="background: white; padding: 2rem; text-align: center; border-radius: var(--border-radius); box-shadow: var(--box-shadow);">
            <h3>No Analysis Data Available</h3>
            <p>{% if search_query %}No patients match your search query: <strong>"{{ search_query }}"</strong>.{% else %}No patient data has been entered yet.{% endif %}</p>
        </div>
        {% endif %}
    </div>

    <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
        <a href="/export_patients" class="btn">Export to Excel</a>
        <a href="/" class="btn btn-secondary">Home</a>
    </div>
</div>
{% endblock %}