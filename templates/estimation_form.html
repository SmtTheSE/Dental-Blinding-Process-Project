<form id="estimation-form" method="POST">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    <input type="hidden" name="code" value="{{ code }}">
    <input type="hidden" name="method" value="{{ method.lower() }}">

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
        <!-- Left Col: Info & Image -->
        <div>
            <h4 style="font-size: 15px; font-weight: 600; margin-bottom: 20px; color: var(--apple-dark);">Patient
                Details</h4>
            <div style="margin-bottom: 30px; font-size: 15px; line-height: 1.6; color: var(--apple-gray);">
                <p>Code: <strong style="color: var(--apple-dark);">{{ code }}</strong></p>
                <p>Method: <strong style="color: var(--apple-dark);">{{ method }}</strong></p>
                <p>Sex: <strong style="color: var(--apple-dark);">{{ sex }}</strong></p>
            </div>

            {% if opg %}
            <div>
                <h4 style="font-size: 15px; font-weight: 600; margin-bottom: 12px; color: var(--apple-dark);">OPG
                    Analysis</h4>

                <!-- OPG Viewer -->
                <div id="opg-viewer-container"
                    style="position: relative; background: #000; border-radius: 12px; overflow: hidden;">
                    <div id="zoom-level"
                        style="position: absolute; top: 12px; right: 12px; z-index: 10; background: rgba(255,255,255,0.2); backdrop-filter: blur(4px); color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 500;">
                        100%</div>

                    <div id="opg-image-wrapper"
                        style="width: 100%; height: 400px; overflow: hidden; cursor: grab; display: flex; align-items: center; justify-content: center;">
                        <img id="opg-image" src="{{ opg }}" alt="OPG"
                            style="max-width: 100%; max-height: 100%; transition: transform 0.2s ease; user-select: none;">
                    </div>

                    <div
                        style="padding: 12px; background: rgba(255,255,255,0.1); text-align: center; font-size: 12px; color: #9ca3af; border-top: 1px solid rgba(255,255,255,0.1);">
                        Scroll to zoom â€¢ Drag to pan
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Col: Input -->
        <div style="display: flex; flex-direction: column; justify-content: center;">
            <h4 style="font-size: 15px; font-weight: 600; margin-bottom: 24px; color: var(--apple-dark);">Your
                Estimation</h4>

            <div style="margin-bottom: 40px;">
                <label for="estimated_age"
                    style="display: block; font-size: 13px; font-weight: 500; color: var(--apple-gray); margin-bottom: 12px;">Estimated
                    Age (Years)</label>
                <!-- Minimal Input -->
                <input type="number" step="0.1" id="estimated_age" name="estimated_age" required
                    style="width: 100%; padding: 16px 0; border: none; border-bottom: 1px solid #d2d2d7; font-size: 32px; font-weight: 600; color: var(--apple-dark); background: transparent; border-radius: 0; outline: none;">
            </div>

            <div style="display: flex; gap: 24px; align-items: center;">
                <button type="submit"
                    style="background: var(--apple-blue); color: white; border: none; padding: 14px 28px; border-radius: 980px; font-size: 15px; font-weight: 600; cursor: pointer; transition: transform 0.2s;">Submit
                    Result</button>
                <button type="button" id="cancel-estimation"
                    style="background: none; border: none; font-size: 15px; color: var(--apple-gray); cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>
</form>

<style>
    #opg-image-wrapper.grabbing {
        cursor: grabbing !important;
    }

    #estimated_age:focus {
        border-color: var(--apple-blue) !important;
    }
</style>

<script>
    (function () {
        const image = document.getElementById('opg-image');
        const wrapper = document.getElementById('opg-image-wrapper');
        const zoomLevelDisplay = document.getElementById('zoom-level');

        if (!image || !wrapper) return;

        let scale = 1, translateX = 0, translateY = 0, isDragging = false, startX = 0, startY = 0, lastTranslateX = 0, lastTranslateY = 0;
        const MIN_SCALE = 1, MAX_SCALE = 5, ZOOM_STEP = 0.3;

        function updateTransform() {
            image.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
            if (zoomLevelDisplay) zoomLevelDisplay.textContent = Math.round(scale * 100) + '%';
        }

        function zoom(delta, centerX, centerY) {
            const oldScale = scale;
            scale = Math.min(Math.max(scale + delta, MIN_SCALE), MAX_SCALE);

            if (scale === MIN_SCALE) { translateX = 0; translateY = 0; }
            else if (centerX !== undefined) {
                const rect = wrapper.getBoundingClientRect();
                const x = centerX - rect.left, y = centerY - rect.top;
                const change = scale / oldScale;
                translateX = x - (x - translateX) * change;
                translateY = y - (y - translateY) * change;
            }
            updateTransform();
        }

        wrapper.addEventListener('wheel', e => { e.preventDefault(); zoom(e.deltaY > 0 ? -ZOOM_STEP : ZOOM_STEP, e.clientX, e.clientY); });

        wrapper.addEventListener('mousedown', e => {
            if (scale > MIN_SCALE) { isDragging = true; wrapper.classList.add('grabbing'); startX = e.clientX; startY = e.clientY; lastTranslateX = translateX; lastTranslateY = translateY; }
        });

        document.addEventListener('mousemove', e => {
            if (isDragging) { translateX = lastTranslateX + (e.clientX - startX); translateY = lastTranslateY + (e.clientY - startY); updateTransform(); }
        });

        document.addEventListener('mouseup', () => { isDragging = false; wrapper.classList.remove('grabbing'); });

        // Touch events omitted for brevity but logic remains same
    })();

    const cancelBtn = document.getElementById('cancel-estimation');
    if (cancelBtn) cancelBtn.addEventListener('click', () => document.getElementById('estimation-modal').style.display = 'none');
</script>