{% extends "base.html" %}

{% block title %}Manage Patients - Dental Age Estimation System{% endblock %}

{% block extra_css %}
<style>
    .section-card {
        background: white;
        border-radius: 18px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
        transition: box-shadow 0.3s;
        max-width: 100%;
        overflow: hidden;
    }

    .section-card:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }

    .section-icon {
        width: 36px;
        height: 36px;
        min-width: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #0071e3 0%, #0077ed 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 16px;
        font-weight: 600;
    }

    .section-title {
        font-size: 21px;
        font-weight: 600;
        margin: 0;
        letter-spacing: -0.009em;
    }

    .info-box {
        background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
        border-left: 4px solid #0071e3;
        padding: 14px 16px;
        border-radius: 12px;
        margin: 12px 0;
    }

    .warning-box {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border-left: 4px solid #f59e0b;
        padding: 14px 16px;
        border-radius: 12px;
        margin: 12px 0;
    }

    .info-box strong,
    .warning-box strong {
        display: block;
        margin-bottom: 6px;
        font-size: 13px;
        font-weight: 600;
    }

    .info-box ul,
    .warning-box ul {
        margin: 6px 0 0 18px;
        font-size: 13px;
        color: var(--apple-gray);
    }

    .info-box p,
    .warning-box p {
        margin: 0;
        font-size: 13px;
        color: var(--apple-gray);
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }

    .search-container {
        background: white;
        border-radius: 18px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
    }

    .search-input {
        flex: 1;
        min-width: 0;
        padding: 12px 16px;
        border: 1px solid #d2d2d7;
        border-radius: 12px;
        font-size: 15px;
        transition: all 0.3s;
        width: 100%;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--apple-blue);
        box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1);
    }

    .empty-state {
        background: white;
        padding: 48px 32px;
        text-align: center;
        border-radius: 18px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .empty-state-icon {
        font-size: 56px;
        margin-bottom: 12px;
        opacity: 0.3;
    }

    .empty-state h3 {
        font-size: 21px;
        font-weight: 600;
        margin-bottom: 6px;
    }

    .empty-state p {
        color: var(--apple-gray);
        font-size: 15px;
    }

    .action-bar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid #e5e5e7;
    }

    .table-container {
        background: white;
        border-radius: 18px;
        overflow-x: auto;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .table-container table {
        box-shadow: none;
        border-radius: 0;
        min-width: 100%;
    }

    .opg-thumbnail {
        width: auto !important;
        height: auto !important;
        max-width: 60px !important;
        max-height: 60px !important;
        min-width: 50px !important;
        min-height: 50px !important;
        border-radius: 6px;
        object-fit: contain;
        display: block;
        border: 1px solid #e5e5e7;
        margin: 4px auto;
    }

    .opg-cell {
        text-align: center;
        vertical-align: middle;
        padding: 8px !important;
        width: 70px;
        min-width: 70px;
    }

    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        background: #f5f5f7;
        color: var(--apple-gray);
        white-space: nowrap;
    }

    .badge-assigned {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #065f46;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .section-card {
            padding: 20px;
        }

        .section-title {
            font-size: 18px;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .action-bar {
            flex-direction: column;
        }

        .action-bar .btn {
            width: 100%;
        }

        .opg-thumbnail {
            max-width: 50px;
            max-height: 50px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Manage Patients</h1>
    <p>Add, import, and manage research participants</p>
</div>

<!-- Import Section -->
<div class="section-card">
    <div class="section-header">
        <div class="section-icon">üìÅ</div>
        <h2 class="section-title">Import Patients from File</h2>
    </div>

    <p style="color: var(--apple-gray); margin-bottom: 16px;">Upload a CSV or Excel file to import multiple patients at
        once. The system will automatically skip patients that already exist in the database.</p>

    <div class="info-box">
        <strong>Supported Formats:</strong>
        <ul>
            <li><strong>Simple Format (Recommended):</strong> ID, Name, Actual Age, Sex</li>
            <li><strong>Full Format:</strong> ID, Name, Age, Sex, OPG, A code, D code, A Age, D Age, Actual age</li>
        </ul>
    </div>

    <div class="warning-box">
        <strong>Note:</strong>
        <p>Images cannot be imported directly from Excel files. Please upload images separately after importing patient
            data.</p>
    </div>

    <form method="POST" enctype="multipart/form-data" style="margin-top: 24px;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="form-group">
            <label for="csv_file">Select CSV or Excel File:</label>
            <input type="file" id="csv_file" name="csv_file" accept=".csv,.xlsx,.xls" required>
            <small style="color: var(--apple-gray);">Supported formats: CSV, XLSX, XLS</small>
        </div>

        <button type="submit" class="btn">Upload File</button>
    </form>
</div>

<!-- Add Patient Section -->
<div class="section-card">
    <div class="section-header">
        <div class="section-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">+</div>
        <h2 class="section-title">Add New Patient</h2>
    </div>

    <form method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="form-grid">
            <div class="form-group">
                <label for="patient_id">Patient ID:</label>
                <input type="text" id="patient_id" name="patient_id" required placeholder="Enter unique ID">
            </div>

            <div class="form-group">
                <label for="name">Name:</label>
                <input type="text" id="name" name="name" placeholder="Enter patient name">
            </div>

            <div class="form-group">
                <label for="actual_age">Actual Age:</label>
                <input type="number" step="0.1" id="actual_age" name="actual_age" required placeholder="0.0">
            </div>

            <div class="form-group">
                <label for="sex">Sex:</label>
                <select id="sex" name="sex">
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
            </div>
        </div>

        <button type="submit" class="btn" style="margin-top: 16px;">Add Patient</button>
    </form>
</div>

<!-- Search Section -->
<div class="search-container">
    <form method="GET" action="/patients">
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <input type="text" name="search" class="search-input" placeholder="Search by Patient ID, Name, or Codes..."
                value="{{ search_query or '' }}">
            <button type="submit" class="btn">Search</button>
            {% if search_query %}
            <a href="/patients" class="btn btn-secondary">Clear</a>
            {% endif %}
        </div>
    </form>
</div>

<!-- Results Section -->
<div id="search-results-container">
    {% if search_query %}
    <div class="info-box"
        style="background: linear-gradient(135deg, #f5f5f7 0%, #e5e5e7 100%); border-left-color: var(--apple-gray);">
        <strong>Search results for: "{{ search_query }}"</strong>
        <p>{{ patients.total }} patient{{ patients.total != 1 and 's' or '' }} found</p>
    </div>
    {% endif %}

    {% if patients.items %}
    <div class="table-container">
        <table>
            <tr>
                <th>Patient ID</th>
                <th>Name</th>
                <th>Actual Age</th>
                <th>Sex</th>
                <th>OPG Image</th>
                <th>Code A</th>
                <th>Code B</th>
                <th>Actions</th>
            </tr>
            {% for patient in patients.items %}
            <tr>
                <td><strong>{{ patient.patient_id }}</strong></td>
                <td>{{ patient.name or 'N/A' }}</td>
                <td>{{ patient.actual_age }}</td>
                <td>{{ patient.sex|capitalize }}</td>
                <td class="opg-cell">
                    {% if patient.opg_link %}
                    <img src="{{ patient.opg_link }}" alt="OPG" class="opg-thumbnail">
                    {% else %}
                    <span class="badge">No image</span>
                    {% endif %}
                </td>
                <td>
                    {% if patient.code_a %}
                    <span class="badge badge-assigned">{{ patient.code_a }}</span>
                    {% else %}
                    <span class="badge">Not assigned</span>
                    {% endif %}
                </td>
                <td>
                    {% if patient.code_b %}
                    <span class="badge badge-assigned">{{ patient.code_b }}</span>
                    {% else %}
                    <span class="badge">Not assigned</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons">
                        <a href="/upload_opg/{{ patient.id }}" class="btn btn-success">Upload OPG</a>
                        <a href="/patients/update/{{ patient.id }}" class="btn btn-warning">Update</a>
                        <form method="POST" action="/patients/delete/{{ patient.id }}" style="display: inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <button type="submit" class="btn btn-danger">Delete</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <!-- Pagination -->
    {% if patients.pages > 1 %}
    <div class="pagination">
        {% if patients.has_prev %}
        <a href="{{ url_for('main.manage_patients', page=patients.prev_num, search=search_query) }}"
            class="btn btn-secondary">‚Üê Previous</a>
        {% else %}
        <span class="btn btn-secondary disabled">‚Üê Previous</span>
        {% endif %}

        {% for page_num in patients.iter_pages() %}
        {% if page_num %}
        {% if page_num != patients.page %}
        <a href="{{ url_for('main.manage_patients', page=page_num, search=search_query) }}" class="btn btn-secondary">{{
            page_num }}</a>
        {% else %}
        <span class="btn current-page">{{ page_num }}</span>
        {% endif %}
        {% else %}
        <span class="ellipsis">‚Ä¶</span>
        {% endif %}
        {% endfor %}

        {% if patients.has_next %}
        <a href="{{ url_for('main.manage_patients', page=patients.next_num, search=search_query) }}"
            class="btn btn-secondary">Next ‚Üí</a>
        {% else %}
        <span class="btn btn-secondary disabled">Next ‚Üí</span>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">üìã</div>
        <h3>No Patients Found</h3>
        <p>{% if search_query %}No patients match your search query: <strong>"{{ search_query }}"</strong>.{% else %}Add
            patients using the forms above to get started.{% endif %}</p>
    </div>
    {% endif %}
</div>

<!-- Action Bar -->
<div class="action-bar">
    <a href="/assign_codes" class="btn">Assign Codes</a>
    <a href="/blinded_data" class="btn">View Blinded Data</a>
    <a href="/analysis" class="btn">Analysis Results</a>
    <a href="/export_patients" class="btn">Export to Excel</a>
    <a href="/" class="btn btn-secondary">‚Üê Back to Dashboard</a>
</div>
{% endblock %}