{% extends "base.html" %}

{% block title %}Manage Patients - Dental Age Estimation System{% endblock %}

{% block content %}
<div class="container">
    <h2>Manage Patients</h2>
    
    <!-- CSV/Excel Import Form -->
    <div style="background: white; padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--box-shadow); margin-bottom: 2rem;">
        <h3>Import Patients from File</h3>
        <p>Upload a CSV or Excel file to import multiple patients at once. The system will automatically skip patients that already exist in the database.</p>
        
        <div style="background-color: #d1ecf1; padding: 1rem; border-radius: var(--border-radius); margin: 1rem 0;">
            <strong>Supported Formats:</strong>
            <ul>
                <li><strong>Simple Format (Recommended):</strong> ID, Name, Actual Age, Sex</li>
                <li><strong>Full Format:</strong> ID, Name, Age, Sex, OPG, A code, D code, A Age, D Age, Actual age</li>
            </ul>
        </div>
        
        <div style="background-color: #fff3cd; padding: 1rem; border-radius: var(--border-radius); margin: 1rem 0;">
            <strong>Note:</strong> Images cannot be imported directly from Excel files. Please upload images separately after importing patient data.
        </div>
        
        <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <div class="form-group">
                <label for="csv_file">Select CSV or Excel File:</label>
                <input type="file" id="csv_file" name="csv_file" accept=".csv,.xlsx,.xls" required>
                <small>Supported formats: CSV, XLSX, XLS</small>
            </div>
            
            <button type="submit" class="btn">Upload File</button>
        </form>
    </div>
    
    <!-- Manual Patient Creation Form -->
    <div style="background: white; padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--box-shadow); margin-bottom: 2rem;">
        <h3>Add New Patient</h3>
        
        <form method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <div class="form-group">
                <label for="patient_id">Patient ID:</label>
                <input type="text" id="patient_id" name="patient_id" required>
            </div>
            
            <div class="form-group">
                <label for="name">Name:</label>
                <input type="text" id="name" name="name">
            </div>
            
            <div class="form-group">
                <label for="actual_age">Actual Age:</label>
                <input type="number" step="0.1" id="actual_age" name="actual_age" required>
            </div>
            
            <div class="form-group">
                <label for="sex">Sex:</label>
                <select id="sex" name="sex">
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
            </div>
            
            <button type="submit" class="btn">Add Patient</button>
        </form>
    </div>
    
    <!-- Search Form -->
    <form method="GET" action="/patients">
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
            <input 
                type="text" 
                name="search" 
                placeholder="Search by Patient ID, Name, or Codes..." 
                value="{{ search_query or '' }}"
                style="flex: 1; min-width: 200px; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: var(--border-radius); font-size: 1rem; box-sizing: border-box;"
            >
            <button type="submit" class="btn">Search</button>
            {% if search_query %}
            <a href="/patients" class="btn btn-secondary">Clear</a>
            {% endif %}
        </div>
    </form>
    
    <div id="search-results-container">
        {% if search_query %}
        <div class="search-results-info">
            Search results for: <strong>"{{ search_query }}"</strong> ({{ patients.total }} patient{{ patients.total != 1 and 's' or '' }})
        </div>
        {% endif %}

        {% if patients.items %}
        <table>
            <tr>
                <th>Patient ID</th>
                <th>Name</th>
                <th>Actual Age</th>
                <th>Sex</th>
                <th>OPG Image</th>
                <th>Code A (AlQahtani)</th>
                <th>Code B (Demirjian)</th>
                <th>Actions</th>
            </tr>
            {% for patient in patients.items %}
            <tr>
                <td>{{ patient.patient_id }}</td>
                <td>{{ patient.name or 'N/A' }}</td>
                <td>{{ patient.actual_age }}</td>
                <td>{{ patient.sex }}</td>
                <td>
                    {% if patient.opg_link %}
                    <img src="{{ patient.opg_link }}" alt="OPG Image" style="max-width: 100px; max-height: 100px; border-radius: 4px;">
                    {% else %}
                    No image
                    {% endif %}
                </td>
                <td>{{ patient.code_a or 'Not assigned' }}</td>
                <td>{{ patient.code_b or 'Not assigned' }}</td>
                <td>
                    <div class="action-buttons">
                        <a href="/upload_opg/{{ patient.id }}" class="btn btn-success">Upload OPG</a>
                        <a href="/patients/update/{{ patient.id }}" class="btn btn-warning">Update</a>
                        <form method="POST" action="/patients/delete/{{ patient.id }}" style="display: inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <button type="submit" class="btn btn-danger">Delete</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </table>
        
        <!-- Pagination Controls -->
        {% if patients.pages > 1 %}
        <div class="pagination">
            <!-- Previous button -->
            {% if patients.has_prev %}
                <a href="{{ url_for('main.manage_patients', page=patients.prev_num, search=search_query) }}" class="btn btn-secondary">&laquo; Previous</a>
            {% else %}
                <span class="btn btn-secondary disabled">&laquo; Previous</span>
            {% endif %}
            
            <!-- Page numbers -->
            {% for page_num in patients.iter_pages() %}
                {% if page_num %}
                    {% if page_num != patients.page %}
                        <a href="{{ url_for('main.manage_patients', page=page_num, search=search_query) }}" class="btn btn-secondary">{{ page_num }}</a>
                    {% else %}
                        <span class="btn active">{{ page_num }}</span>
                    {% endif %}
                {% else %}
                    <span class="ellipsis">â€¦</span>
                {% endif %}
            {% endfor %}
            
            <!-- Next button -->
            {% if patients.has_next %}
                <a href="{{ url_for('main.manage_patients', page=patients.next_num, search=search_query) }}" class="btn btn-secondary">Next &raquo;</a>
            {% else %}
                <span class="btn btn-secondary disabled">Next &raquo;</span>
            {% endif %}
        </div>
        {% endif %}
        
        {% else %}
        <div style="background: white; padding: 2rem; text-align: center; border-radius: var(--border-radius); box-shadow: var(--box-shadow);">
            <h3>No Patients Found</h3>
            <p>{% if search_query %}No patients match your search query: <strong>"{{ search_query }}"</strong>.{% else %}Add patients using the form above.{% endif %}</p>
        </div>
        {% endif %}
    </div>

    <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
        <a href="/assign_codes" class="btn">Assign Codes</a>
        <a href="/blinded_data" class="btn">View Blinded Data</a>
        <a href="/analysis" class="btn">Analysis Results</a>
        <a href="/export_patients" class="btn">Export Patients to Excel</a>
        <a href="/" class="btn btn-secondary">Home</a>
    </div>
</div>
{% endblock %}