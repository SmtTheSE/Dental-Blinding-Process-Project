{% extends "base.html" %}

{% block title %}Manage Patients - Dental Age Estimation System{% endblock %}

{% block extra_css %}
<style>
    /* Minimalist Search */
    .search-container {
        margin-bottom: 40px;
        animation: fadeInUp 0.6s ease-out backwards;
    }

    .search-input {
        width: 100%;
        max-width: 400px;
        padding: 12px 0;
        border: none;
        border-bottom: 1px solid #d2d2d7;
        font-size: 24px;
        font-weight: 600;
        color: var(--apple-dark);
        background: transparent;
        transition: border-color 0.2s;
        border-radius: 0;
        /* Remove default radius */
    }

    .search-input:focus {
        outline: none;
        border-color: var(--apple-blue);
        box-shadow: none;
    }

    .search-input::placeholder {
        color: #d2d2d7;
        font-weight: 500;
    }

    /* Minimalist Sections */
    .minimal-section {
        margin-top: 120px;
        /* Added to push table down */
        margin-bottom: 100px;
        /* Increased from 60px */
        animation: fadeInUp 0.6s ease-out backwards;
    }

    .minimal-section h2 {
        font-size: 24px;
        /* Increased from 21px */
        font-weight: 600;
        margin-bottom: 40px;
        /* Increased from 24px */
        color: var(--apple-dark);
        letter-spacing: -0.01em;
    }

    .form-minimal-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 40px;
        /* Increased from 32px */
        align-items: end;
    }

    .form-group-minimal label {
        display: block;
        margin-bottom: 12px;
        /* Increased from 8px */
        font-size: 13px;
        font-weight: 500;
        color: var(--apple-gray);
    }

    .form-group-minimal input,
    .form-group-minimal select {
        width: 100%;
        padding: 16px 0;
        /* Increased from 10px */
        border: none;
        border-bottom: 1px solid #e5e5ea;
        background: transparent;
        font-size: 19px;
        /* Increased from 17px */
        color: var(--apple-dark);
        border-radius: 0;
        transition: border-color 0.2s;
    }

    .form-group-minimal input:focus,
    .form-group-minimal select:focus {
        outline: none;
        border-color: var(--apple-blue);
        box-shadow: none;
    }

    /* Table Minimal */
    .table-minimal {
        width: 100%;
        border-collapse: collapse;
    }

    .table-minimal th {
        text-align: left;
        padding: 20px 0;
        /* Increased from 16px */
        font-size: 13px;
        font-weight: 600;
        color: var(--apple-gray);
        text-transform: uppercase;
        border-bottom: 1px solid #e5e5ea;
        background: transparent;
    }

    .table-minimal td {
        padding: 28px 0;
        /* Increased from 20px */
        border-bottom: 1px solid #f5f5f7;
        font-size: 16px;
        /* Slightly larger */
        color: var(--apple-dark);
    }

    .table-minimal tr:last-child td {
        border-bottom: none;
    }

    /* Action Links */
    .action-link {
        color: var(--apple-blue);
        text-decoration: none;
        font-size: 15px;
        margin-right: 24px;
        font-weight: 500;
        transition: opacity 0.2s;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
    }

    .action-link:hover {
        opacity: 0.7;
    }

    .action-link.delete {
        color: var(--apple-gray);
    }

    .action-link.delete:hover {
        color: #ff3b30;
    }

    /* Layout Utils */
    .split-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 120px;
        /* Doubled from 60px */
        margin-bottom: 180px;
        /* Increased from 100px to push table down */
        animation: fadeInUp 0.6s ease-out 0.1s backwards;
    }

    @media (max-width: 900px) {
        .split-layout {
            grid-template-columns: 1fr;
            gap: 40px;
            /* Reduced from 60px/120px */
            margin-bottom: 80px;
        }

        .search-input {
            width: 100%;
            max-width: none;
            /* Full width on mobile */
            font-size: 20px;
        }

        .minimal-section h2 {
            font-size: 20px;
            margin-bottom: 24px;
        }
    }

    /* Scrollable Table Container */
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -24px;
        /* Negative margin to bleed to edge on mobile */
        padding: 0 24px;
        /* Padding to align content */
    }

    @media (max-width: 768px) {
        .table-responsive {
            margin: 0 -16px;
            padding: 0 16px;
        }
    }

    .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
    }

    .file-input-btn {
        color: var(--apple-blue);
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
    }

    .file-input-wrapper input[type=file] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
        width: 100%;
        height: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header" style="margin-bottom: 60px;">
    <h1>Patients</h1>
    <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 24px;">
        <p style="margin: 0; max-width: 500px;">Manage study research database.</p>

        <!-- Search Inline -->
        <form method="GET" action="/patients"
            style="display: flex; align-items: center; border-bottom: 1px solid #d2d2d7;">
            <span style="color: #d2d2d7; margin-right: 8px;">üîç</span>
            <input type="text" name="search" placeholder="Search patients" value="{{ search_query or '' }}"
                style="border: none; background: transparent; padding: 8px 0; font-size: 15px; width: 200px; outline: none;">
            {% if search_query %}
            <a href="/patients"
                style="color: var(--apple-gray); text-decoration: none; font-size: 18px; margin-left: 8px;">√ó</a>
            {% endif %}
        </form>
    </div>
</div>

<!-- Forms Section -->
<div class="split-layout">
    <!-- Quick Add -->
    <div>
        <h2 style="font-size: 19px; font-weight: 600; margin-bottom: 24px;">Add Patient</h2>
        <form method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <div style="display: grid; gap: 20px;">
                <div class="form-group-minimal">
                    <label>Patient ID</label>
                    <input type="text" name="patient_id" required placeholder="P-001">
                </div>
                <div class="form-group-minimal">
                    <label>Full Name</label>
                    <input type="text" name="name" placeholder="Optional">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group-minimal">
                        <label>Age</label>
                        <input type="number" step="0.1" name="actual_age" required placeholder="0.0">
                    </div>
                    <div class="form-group-minimal">
                        <label>Sex</label>
                        <select name="sex">
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="action-link" style="text-align: left; margin-top: 12px; font-size: 15px;">+
                    Add Patient</button>
            </div>
        </form>
    </div>

    <!-- Import -->
    <div>
        <h2 style="font-size: 19px; font-weight: 600; margin-bottom: 24px;">Import Data</h2>
        <p style="font-size: 15px; color: var(--apple-gray); line-height: 1.5; margin-bottom: 24px;">
            Upload CSV or Excel files for bulk import. <br>
            Supported formats: ID, Name, Age, Sex layout.
        </p>

        <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div class="file-input-wrapper">
                    <span class="file-input-btn">Choose File</span>
                    <input type="file" name="csv_file" accept=".csv,.xlsx,.xls" onchange="this.form.submit()">
                </div>
                <span style="font-size: 13px; color: var(--apple-gray);">No file chosen</span>
            </div>
        </form>
    </div>
</div>

<!-- Patients List -->
<div class="minimal-section" style="animation-delay: 0.2s;">
    {% if patients.items %}
    <div class="table-responsive">
        <table class="table-minimal">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Patient Name</th>
                    <th>Age</th>
                    <th>Sex</th>
                    <th>OPG Status</th>
                    <th>Blind Code A</th>
                    <th>Blind Code B</th>
                    <th style="text-align: right;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for patient in patients.items %}
                <tr>
                    <td style="font-weight: 500;">{{ patient.patient_id }}</td>
                    <td>{{ patient.name or '‚Äî' }}</td>
                    <td>{{ patient.actual_age }}</td>
                    <td style="text-transform: capitalize;">{{ patient.sex }}</td>
                    <td>
                        {% if patient.opg_link %}
                        <span style="color: #34c759; font-size: 13px;">Uploaded</span>
                        {% else %}
                        <span style="color: var(--apple-gray); font-size: 13px;">Missing</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if patient.code_a %}
                        <span
                            style="font-family: monospace; background: #f5f5f7; padding: 2px 6px; border-radius: 4px;">{{
                            patient.code_a }}</span>
                        {% else %}
                        <span style="color: var(--apple-gray);">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if patient.code_b %}
                        <span
                            style="font-family: monospace; background: #f5f5f7; padding: 2px 6px; border-radius: 4px;">{{
                            patient.code_b }}</span>
                        {% else %}
                        <span style="color: var(--apple-gray);">‚Äî</span>
                        {% endif %}
                    </td>
                    <td style="text-align: right; white-space: nowrap;">
                        <a href="/upload_opg/{{ patient.id }}" class="action-link">Upload</a>
                        <a href="/patients/update/{{ patient.id }}" class="action-link">Edit</a>
                        <form method="POST" action="/patients/delete/{{ patient.id }}" style="display: inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <button type="submit" class="action-link delete">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Minimal Pagination -->
    {% if patients.pages > 1 %}
    <div style="margin-top: 40px; display: flex; gap: 20px; justify-content: center;">
        {% if patients.has_prev %}
        <a href="{{ url_for('main.manage_patients', page=patients.prev_num, search=search_query) }}"
            class="action-link">Previous</a>
        {% endif %}

        <span style="color: var(--apple-gray); font-size: 13px;">Page {{ patients.page }} of {{ patients.pages }}</span>

        {% if patients.has_next %}
        <a href="{{ url_for('main.manage_patients', page=patients.next_num, search=search_query) }}"
            class="action-link">Next</a>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <div style="padding: 60px 0; text-align: center; color: var(--apple-gray);">
        <p>No patients found in the database.</p>
    </div>
    {% endif %}
</div>

<!-- Simple Footer Links -->
<div style="margin-top: 80px; text-align: center; display: flex; gap: 24px; justify-content: center;">
    <a href="/" class="minimal-link"
        style="font-size: 15px; color: var(--apple-blue); text-decoration: none;">Dashboard</a>
    <a href="/assign_codes" class="minimal-link"
        style="font-size: 15px; color: var(--apple-blue); text-decoration: none;">Assign Codes</a>
    <a href="/analysis" class="minimal-link"
        style="font-size: 15px; color: var(--apple-blue); text-decoration: none;">Analysis</a>
</div>
{% endblock %}